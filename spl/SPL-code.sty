\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{SPL-code}[2015/01/14 Packages, commands, etc for typesetting source code]
\typeout{Document Style `SPL-code.sty' <2015/01/14>}
\typeout{Rev. 1.0.0}

\RequirePackage{ifxetex}
\ifxetex
  \RequirePackage{fontspec}                   % font selection when using xelatex and Windows system fonts
  % Download and install as a Windows system font
  % https://bdtechconcepts.com/Inconsolata-LGC-Markup-Font.html
  \setmonofont[Extension=.otf, ItalicFont =*-Italic, BoldFont=*-Bold, Scale=MatchLowercase]{InconsolataLGCMarkup}

  % Make sure to use straight quotes in code samples.
  % The code listings font looks better with XeTeX but pdfLaTeX can be used as well with the default monospaced font.
\fi

\RequirePackage{listings}
\RequirePackage{lstautogobble}  % gobble up leading spaces and preserve indentation, from https://www.ctan.org/pkg/lstaddons

% colour definitions for code listings
\RequirePackage{color}
\definecolor{blue}{rgb}{0.13,0.13,1}
\definecolor{green}{rgb}{0,0.5,0}
\definecolor{darkbrown}{HTML}{87422B}

% base style for C++
\lstdefinestyle{base}{
basicstyle=\lst@ifdisplaystyle\ttfamily\small\fi, %https://tex.stackexchange.com/questions/161549/scaling-inline-code-to-the-current-font-size
tabsize=3,
autogobble,
language=[11]C++,
morekeywords={override, default, final, constexpr, char8_t, concept, co_await, co_return, co_yield, requires, import, module}, % C++20 keywords
showstringspaces=false,
breaklines=true,
breakatwhitespace=true,
captionpos=b,
moredelim=[il]{//*},
escapeinside=\`\`,
escapechar=\`,
}

% base style modifiers
\lstdefinestyle{indented}{xleftmargin=1.5em, xrightmargin=1.5em}
\lstdefinestyle{framed}{frame=tlrb, framexleftmargin=1mm, aboveskip=2em, abovecaptionskip=4mm, rulecolor = \color{black}}
\lstdefinestyle{numbered}{numbers=left, numberstyle=\ttfamily\color{black!35}\footnotesize, xleftmargin=2.5em, xrightmargin=2.5em}
\lstdefinestyle{coloured}{stringstyle=\color{darkbrown}, commentstyle=\color{green}\itshape, keywordstyle=\color{blue}}

% styles for documents
\lstdefinestyle{inline}{basicstyle=\ttfamily} % font size is scaled to surrounding font size with MatchLowercase
\lstdefinestyle{snippet}{style=base, style=indented, aboveskip=1.2ex, belowskip=0.45ex}
\lstdefinestyle{in-frame}{style=base, style=framed}
\lstdefinestyle{appendix}{style=base, style=framed}
\lstdefinestyle{output}{style=in-frame, style=indented, keywordstyle={}}
\lstdefinestyle{ruled}{basicstyle=\small\ttfamily, breaklines=true, frame=tb, framextopmargin=2mm, framexbottommargin=2mm, rulecolor=\color{gray!90}, xleftmargin=3pt, xrightmargin=3pt, aboveskip=3.2ex, belowskip=1.45ex}
\lstdefinestyle{boxed}{basicstyle=\small\ttfamily, breaklines=true, backgroundcolor=\color{gray!15}, frame=single, rulecolor=\color{gray!50}, xleftmargin=3pt, xrightmargin=3pt, aboveskip=1.2ex, belowskip=0.45ex}
\lstdefinestyle{exercise-print}{style=in-frame, style=numbered}
\lstdefinestyle{exercise}{style=in-frame, style=numbered, style=coloured}

% styles for slides
\lstdefinestyle{slide}{
		style=base,
		style=coloured,
		escapeinside={(*@}{@*)},
		escapechar=\$,
    moredelim=**[is][{\btHL[fill=yellow]}]{`}{`}, % yellow highlight
    moredelim=**[is][{\btHL[name=X,draw=red,solid,thick]}]{@}{@}, % red border
}
\lstdefinestyle{numbered-slide}{style=slide, numbers=left, numberstyle=\tiny}

% styles for MCQ
\lstdefinestyle{mcq}{style=base, style=framed, xrightmargin=2.5em}
\lstdefinestyle{numbered-mcq}{style=mcq, style=numbered, xleftmargin=4.5em}

% rule after listing
\newcommand{\coderule}{
\vspace{-5.5mm}
\makebox[0pt][l]{%
  \rule[-1pt]{\textwidth}{.4pt}%
  \rule[-2.6pt]{4pt}{4pt}
}%
\vspace{2mm}
}

%------------------------------------------------------------------------------
%    Print file path and name outside frame for exercise style (bottom-right)
%------------------------------------------------------------------------------
% This command relies on \lstinputlisting setting \lstname so that the file and path
% name can be extracted. It does not work properly if there is a caption for the listing.
% The file path must not be surrounded by quotes.

% https://tex.stackexchange.com/questions/514076/regular-expression-with-listings-to-extract-filename-from-path/514083
\def\extractPath#1code/#2\relax{#2}
\newcommand{\filepathname}{\expandafter\extractPath\lstname\relax}
\newcommand{\codefile}{\vspace{-3.5mm}\makebox[0.948\linewidth][r]{\footnotesize \texttt{\filepathname}}}

% See also: https://tex.stackexchange.com/questions/240998/how-to-show-a-filename-above-a-code-snippet-just-like-on-the-arch-wiki

%------------------------------------------------------------------------------
%                         Code Highlighting (see slide style above)
%------------------------------------------------------------------------------

% from https://tex.stackexchange.com/questions/15237/highlight-text-in-code-listing-while-also-keeping-syntax-highlighting/

% to remove space being highlighted at the begin of a line, escape to LaTeX
% just before the highlighting starts, eg:
% // class member initialisation
% D::D(int a, int b):
%   $$`m{a, b}`
% {
%     // ...
% };

\makeatletter
\newenvironment{btHighlight}[1][]
{\begingroup\tikzset{bt@Highlight@par/.style={#1}}\begin{lrbox}{\@tempboxa}}
{\end{lrbox}\bt@HL@box[bt@Highlight@par]{\@tempboxa}\endgroup}

\newcommand\btHL[1][]{%
  \begin{btHighlight}[#1]\bgroup\aftergroup\bt@HL@endenv%
}
\def\bt@HL@endenv{%
  \end{btHighlight}%
  \egroup
}
\newcommand{\bt@HL@box}[2][]{%
  \tikz[#1]{%
    \pgfpathrectangle{\pgfpoint{1pt}{0pt}}{\pgfpoint{\wd #2}{\ht #2}}%
    \pgfusepath{use as bounding box}%
    \node[anchor=base west, outer xsep = 0pt, inner xsep=1pt, inner ysep=-1pt, rounded corners=3pt, minimum height=0pt,#1]{\raisebox{1pt}{\strut}\strut\usebox{#2}};
  }%
}
\makeatother

%------------------------------------------------------------------------------

% Typeset listing and captions as shown here:
% https://tex.stackexchange.com/questions/14967/source-code-listing-with-frame-around-code

%\usepackage{caption}
%\DeclareCaptionFont{white}{\color{white}}
%\DeclareCaptionFormat{listing}{\colorbox[cmyk]{0.43, 0.35, 0.35,0.01}{\parbox{\textwidth}{#1#2#3}}}
%\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white, singlelinecheck=false, margin=0pt, font={bf,footnotesize}}

%\usepackage{tcolorbox}
%  \tcbuselibrary{breakable}
%  \tcbuselibrary{skins}
%  \tcbuselibrary{listings}
%\usepackage{caption}

%\definecolor{shadecolor}{gray}{0.95}
%\definecolor{captionbox}{cmyk}{0.43, 0.35, 0.35,0.01}

%\newtcblisting[auto counter]{wgetlisting}[2][]{%
%  listing only,
%  breakable,
%  top=0.5pt,
%  bottom=0.5pt,
%  colback=red!5!white,
%  colframe=red!25,
%  left=6mm,
%  sharp corners,
%  boxrule=0pt,
%  bottomrule=1pt,
%  toprule=1pt,
%  enhanced jigsaw,
%  listing options={%style=tcblatex,
%    numbers=left,
%    numberstyle=\tiny\color{red!75!black},
%    moredelim={[is][keywordstyle]{@@}{@@}},
%    basicstyle=\normalsize\ttfamily,
%    breaklines=true,
%    breakautoindent=false,
%    breakindent=0pt,
%    escapeinside={(*}{*)},
%  },%
%  lefttitle=0pt,
%  coltitle=black,
%  colbacktitle=white,
%  title={Listing \thetcbcounter:  #2},#1%
%  borderline north={8pt}{14.4pt}{red!25,dashed},
%}
